generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

/// Modelo para Usuários e Administradores (Atores)
/// Baseado nos requisitos RF1, RF3, RF10, RF14
model User {
  matricula         String        @id
  nome              String
  email             String        @unique
  senha             String
  role              Role          @default(ALUNO)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  cartItems         CartItem[]
  chatThread        ChatMessage[] @relation("ChatThread")
  folderMemberships FolderUser[]
  loans             Loan[]
  reservations      Reservation[]
}

/// Modelo para a Obra (Livro)
/// Baseado nos requisitos RF07 e RF20.1
model Book {
  id         String     @id @default(cuid())
  isbn       String     @unique
  titulo     String
  autor      String
  coAutores  String[]
  edicao     String
  anoEdicao  Int
  idioma     String
  publicacao String
  resumo     String?
  imageUrl   String?
  tipo       BookType
  copies     BookCopy[]
  cartItems  CartItem[]
  folders    Folder[]   @relation("BookFolders")
}

/// Modelo para o Exemplar (Cópia física)
/// Baseado nos requisitos RF22 e RF23
model BookCopy {
  id          String        @id @default(cuid())
  bookId      String
  copyNumber  Int
  status      CopyStatus    @default(DISPONIVEL)
  condition   BookCondition @default(BOA)
  book        Book          @relation(fields: [bookId], references: [id], onDelete: Cascade)
  loans       Loan[]
  reservation Reservation?

  @@unique([bookId, copyNumber])
}

/// Modelo para Empréstimos (Aluguel)
/// Baseado nos requisitos RF08 e RF23.5
model Loan {
  id             String     @id @default(cuid())
  userMatricula  String
  bookCopyId     String
  dataEmprestimo DateTime   @default(now())
  dataLimite     DateTime
  dataDevolucao  DateTime?
  status         LoanStatus @default(ATIVO)
  renovacoes     Int        @default(0)
  divida         Float      @default(0.0)
  bookCopy       BookCopy   @relation(fields: [bookCopyId], references: [id])
  user           User       @relation(fields: [userMatricula], references: [matricula])
}

/// Modelo para Reservas
/// Baseado nos requisitos RF08 e RF23.10
model Reservation {
  id            String            @id @default(cuid())
  userMatricula String
  bookCopyId    String            @unique
  dataReserva   DateTime          @default(now())
  dataLimite    DateTime
  status        ReservationStatus @default(ATIVA)
  bookCopy      BookCopy          @relation(fields: [bookCopyId], references: [id])
  user          User              @relation(fields: [userMatricula], references: [matricula])
}

/// Modelo para Pastas de Livros (RF09, RF10)
model Folder {
  id        String       @id @default(cuid())
  nome      String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  users     FolderUser[]
  books     Book[]       @relation("BookFolders")
}

/// Tabela de Junção para Pastas <-> Usuários com Permissões
/// Baseado no requisito RF10.5, RF10.6
model FolderUser {
  folderId      String
  userMatricula String
  role          FolderRole @default(LEITOR)
  folder        Folder     @relation(fields: [folderId], references: [id], onDelete: Cascade)
  user          User       @relation(fields: [userMatricula], references: [matricula], onDelete: Cascade)

  @@id([folderId, userMatricula])
}

/// Modelo para Itens na Cesta (RF06, RF07.3)
/// Tabela de Junção (Muitos-para-Muitos) entre User e Book
model CartItem {
  userMatricula String
  bookId        String
  addedAt       DateTime @default(now())
  book          Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userMatricula], references: [matricula], onDelete: Cascade)

  @@id([userMatricula, bookId])
}

/// Modelo para Mensagens do Chat (RF28)
model ChatMessage {
  id            String   @id @default(cuid())
  userMatricula String
  senderRole    Role
  text          String
  timestamp     DateTime @default(now())
  user          User     @relation("ChatThread", fields: [userMatricula], references: [matricula], onDelete: Cascade)
}

/// Enum para os papéis de usuário (RF1.5)
enum Role {
  ALUNO
  ADMINISTRADOR
  SUPER
}

/// Enum para os tipos de obra (RF07, RF20.1)
enum BookType {
  FISICO
  DIGITAL
}

/// Enum para o status dos exemplares (RF22.2-RF22.5)
enum CopyStatus {
  DISPONIVEL
  ALUGADO
  RESERVADO
  INDISPONIVEL
}

/// Enum para a condição física do exemplar (RF23.3)
enum BookCondition {
  MUITO_BOA
  BOA
  CONSERVADO
  RUIM
  MUITO_RUIM
}

/// Enum para o status do empréstimo (RF08.1)
enum LoanStatus {
  ATIVO
  DEVOLVIDO
}

/// Enum para o status da reserva (RF23.10, RF23.12)
enum ReservationStatus {
  ATIVA
  CANCELADA
  EXPIRADA
  CONCLUIDA
}

/// Enum para permissões em Pastas (RF10.6, RF10.11)
enum FolderRole {
  PROPRIETARIO
  EDITOR
  LEITOR
}
